# P2P коммуникация через NAT

Проект демонстрирует реализацию P2P соединения между клиентами, находящимися за NAT, с использованием техники UDP hole punching.

## Использованные методики

1. UDP Hole Punching
    - Техника для установки P2P соединения между клиентами за NAT
    - Использует промежуточный сервер (Rendezvous Server) для обмена информацией о конечных точках
    - Требует поддержки со стороны NAT для сохранения консистентного маппинга портов

2. Клиент-серверная архитектура для начального этапа
    - Централизованный сервер для регистрации клиентов
    - Обмен информацией о публичных endpoints между клиентами
    - Поддержка нескольких одновременных клиентских соединений

3. Асинхронная обработка сообщений
    - Отдельный поток для приема сообщений
    - Неблокирующая отправка сообщений
    - Обработка различных типов сообщений (регистрация, punch, подтверждения и т.д.)

## Требования

- Java 11 или выше
- Maven 3.6 или выше
- Открытый порт на сервере для входящих UDP соединений
- Поддержка UDP hole punching на NAT клиентов

## Сборка

```bash
mvn clean package
```

## Запуск

### 1. Запуск сервера
```bash
java -cp target/p2p-nat-1.0.jar com.p2pmail.Main server
```

### 2. Запуск клиентов
```bash
# Клиент 1
java -cp target/p2p-nat-1.0.jar com.p2pmail.Main client1

# Клиент 2
java -cp target/p2p-nat-1.0.jar com.p2pmail.Main client2
```

## Известные ограничения

1. **Казахстанские провайдеры и NAT**
    - В Казахстане большинство провайдеров используют многоуровневый NAT (Carrier Grade NAT)
    - UDP hole punching не работает в такой конфигурации, так как:
        - Отсутствует прямая видимость между клиентами
        - Провайдерский NAT блокирует "нестандартные" соединения
        - Нет возможности сохранения консистентного маппинга портов

2. **Рекомендуемые альтернативы для Казахстана**
    - Использование VPS с публичным IP для relay-сервера
    - Настройка VPN между участниками
    - Получение статического IP у провайдера (если доступно)

## Troubleshooting

1. Проверьте доступность портов:
```bash
# На Linux
netstat -tulpn | grep LISTEN

# На Windows
netstat -an | findstr LISTENING
```

2. Проверьте настройки файрвола:
```bash
# На Linux
sudo iptables -L

# На Windows
netsh advfirewall show currentprofile
```

3. Проверьте работу UDP:
```bash
# Отправка тестового UDP пакета
nc -u [IP] [PORT]
```

## Дополнительно

Проект основан на исследовании ["Peer-to-Peer Communication Across Network Address Translators"](https://bford.info/pub/net/p2pnat/) и адаптирован для современных сетевых условий.

## Лицензия

MIT